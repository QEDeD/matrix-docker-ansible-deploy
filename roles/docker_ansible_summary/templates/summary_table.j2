{#
SPDX-FileCopyrightText: 2025 MDAD project contributors
SPDX-License-Identifier: AGPL-3.0-or-later
#}
{% macro render_border(left, middle, right, widths, hchar) -%}
{{ left }}{% for width in widths %}{{ hchar * (width + 2) }}{% if not loop.last %}{{ middle }}{% endif %}{% endfor %}{{ right }}
{%- endmacro %}

{% macro cell(text, width, default, ellipsis_token) -%}
{% set raw = (text if text not in [none, ''] else default)|string %}
{% set display = raw | docker_summary_truncate(width, ellipsis_token) %}
{{ "%-*s" | format(width, display) }}
{%- endmacro %}

{% macro render_row(values, widths, chars, defaults, ellipsis_token) -%}
{% set ns = namespace(segments=[]) %}
{% for value in values -%}
{% set default_value = '' -%}
{% if defaults is not none and defaults|length > loop.index0 -%}
{% set default_value = defaults[loop.index0] -%}
{% endif -%}
{% set seg = ' ' ~ (cell(value, widths[loop.index0], default_value, ellipsis_token)) ~ ' ' %}
{% set ns.segments = ns.segments + [seg] %}
{% endfor %}
{{- chars.v }}{{ ns.segments | join(chars.v) }}{{ chars.v }}
{%- endmacro %}

{% set chars = summary_table_chars %}
{% set ellipsis_token = summary_table_ellipsis | default('...') %}
{% set show_notes = summary_table_show_notes | default(false) %}
{% set service_width = summary_table_service_width | int %}
{% set version_width = summary_table_version_width | int %}
{% set status_width = summary_table_status_width | int %}
{% set notes_width = summary_table_notes_width | default(0) | int %}

{# Adaptive width calculations #}
{% if summary_table_auto_width %}
  {% set service_ns = namespace(value=service_width) %}
  {% set service_ns.value = [service_ns.value, summary_table_service_width_min, 'SERVICE/CONTAINER'|length]|max %}
  {% for key, entry in after_versions | dictsort %}
    {% set service_ns.value = [service_ns.value, key|string|length]|max %}
  {% endfor %}
  {% set service_width = [service_ns.value, summary_table_service_width_max]|min %}

  {% set version_ns = namespace(value=version_width) %}
  {% set version_ns.value = [version_ns.value, summary_table_version_width_min, 'VERSION BEFORE'|length, 'VERSION AFTER'|length]|max %}
  {% for key, entry in after_versions | dictsort %}
    {% set version_ns.value = [version_ns.value, entry.previous | default('-', true) | string | length, entry.current | string | length]|max %}
  {% endfor %}
  {% set version_width = [version_ns.value, summary_table_version_width_max]|min %}

  {% set status_ns = namespace(value=status_width) %}
  {% set status_ns.value = [status_ns.value, summary_table_status_width_min, 'STATUS'|length]|max %}
  {% for key, entry in after_versions | dictsort %}
    {% set status_ns.value = [status_ns.value, entry.status_label | string | length]|max %}
  {% endfor %}
  {% set status_width = [status_ns.value, summary_table_status_width_max]|min %}

  {% if show_notes %}
    {% set notes_ns = namespace(value=notes_width) %}
    {% set notes_ns.value = [notes_ns.value, summary_table_notes_width_min, 'NOTES'|length]|max %}
    {% for key, entry in after_versions | dictsort %}
      {% set notes_ns.value = [notes_ns.value, entry.notes | default('', true) | string | length]|max %}
    {% endfor %}
    {% set notes_width = [notes_ns.value, summary_table_notes_width_max]|min %}
  {% endif %}
{% endif %}

{% set columns = [
  ('SERVICE/CONTAINER', service_width),
  ('VERSION BEFORE', version_width),
  ('VERSION AFTER', version_width),
  ('STATUS', status_width)
] %}
{% if show_notes %}
  {% set columns = columns + [('NOTES', notes_width)] %}
{% endif %}

{% set column_widths = columns | map(attribute=1) | list %}
{% set header_values = columns | map(attribute=0) | list %}
{% set data_defaults = ['', '-', '', ''] %}
{% if show_notes %}
  {% set data_defaults = data_defaults + [''] %}
{% endif %}

{{- 'DOCKER SERVICE VERSION CHANGES - ' ~ ansible_facts.date_time.iso8601 ~ '\n' -}}
{{- render_border(chars.tl, chars.t_down, chars.tr, column_widths, chars.h) ~ '\n' -}}
{{- render_row(header_values, column_widths, chars, None, ellipsis_token) | regex_replace('^\\s+', '') ~ '\n' -}}
{{- render_border(chars.t_right, chars.double_cross, chars.t_left, column_widths, chars.double_h) ~ '\n' -}}
{% for key, entry in after_versions | dictsort -%}
{% set row_values = [
  key,
  entry.previous | default('-', true),
  entry.current,
  entry.status_label
] -%}
{% if show_notes -%}
{% set row_values = row_values + [entry.notes | default('', true)] -%}
{% endif -%}
{{- render_row(row_values, column_widths, chars, data_defaults, ellipsis_token) | regex_replace('^\\s+', '') ~ '\n' -}}
{% endfor -%}
{{- render_border(chars.bl, chars.t_up, chars.br, column_widths, chars.h) ~ '\n' -}}
{{- 'Total services listed: ' ~ (after_versions | length) ~ ' (active: ' ~ (filtered_containers | length) ~ ')' ~ '\n' -}}
{% if is_status_display -%}
{{- '[CURRENT STATUS DISPLAY - NO CHANGES RECORDED]' }}
{% elif has_changes -%}
{{- '[NEW VERSION CHANGES RECORDED]' }}
{% elif first_run -%}
{{- '[INITIAL STATE RECORDED]' }}
{% else -%}
{{- '[NO CHANGES DETECTED]' }}
{% endif -%}
{% if (summary_recovery_mode | default(false)) and not is_status_display -%}
{{- '\n[RECOVERY NOTICE] Includes changes first detected in an earlier run where the summary was not displayed.' }}
{% endif -%}
