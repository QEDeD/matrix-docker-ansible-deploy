---
# SPDX-FileCopyrightText: 2025 MDAD project contributors
# SPDX-License-Identifier: AGPL-3.0-or-later

- name: Override DAS scope for matrix containers
  ansible.builtin.set_fact:
    docker_ansible_summary_scope: "{{ das_matrix_scope_pattern }}"

- name: Capture baseline summary for matrix scope
  ansible.builtin.include_role:
    name: docker_ansible_summary
  vars:
    docker_ansible_summary_scope:
      - "{{ das_matrix_scope_pattern }}"
    docker_ansible_summary_write_facts: false
    docker_ansible_summary_enable_discovery: true
    docker_ansible_summary_table_style_unicode: false
    docker_ansible_summary_ansible_local_override: {}

- name: Debug baseline contents
  ansible.builtin.debug:
    msg: "Baseline after_versions keys: {{ after_versions.keys() | list }}"

- name: Assert baseline captured matrix services
  ansible.builtin.assert:
    that:
      - after_versions | length == (das_matrix_containers | length)
      - (after_versions.keys() | list | difference(das_matrix_containers | map(attribute='name') | list) | length) == 0
    fail_msg: "Baseline summary should include every matrix-* container"

- name: Cache baseline versions and history
  ansible.builtin.set_fact:
    das_matrix_versions_baseline: "{{ current_versions }}"
    das_matrix_history_baseline: "{{ version_history }}"
    current_versions: {}
    after_versions: {}

- name: Upgrade matrix-api container image
  community.docker.docker_container:
    name: "{{ das_matrix_api_name }}"
    image: alpine:3.20
    command: "sleep 3600"
    state: started
    recreate: true
    pull: true
    networks:
      - name: "{{ das_test_network }}"
  tags: ["fixtures"]

- name: Remove matrix-worker to simulate decommission
  community.docker.docker_container:
    name: "{{ das_matrix_worker_name }}"
    state: absent
    force_kill: true
  tags: ["fixtures"]

- name: Override DAS scope for matrix containers (update pass)
  ansible.builtin.set_fact:
    docker_ansible_summary_scope: "{{ das_matrix_scope_pattern }}"

- name: Capture updated summary after changes
  ansible.builtin.include_role:
    name: docker_ansible_summary
  vars:
    docker_ansible_summary_scope:
      - "{{ das_matrix_scope_pattern }}"
    docker_ansible_summary_write_facts: false
    docker_ansible_summary_enable_discovery: true
    docker_ansible_summary_table_style_unicode: false
    docker_ansible_summary_ansible_local_override:
      matrix_versions: "{{ das_matrix_versions_baseline }}"
      matrix_version_history: "{{ das_matrix_history_baseline }}"

- name: Debug updated services
  ansible.builtin.debug:
    msg:
      - "current_versions keys: {{ current_versions.keys() | list }}"
      - "after_versions keys: {{ after_versions.keys() | list }}"
      - "{{ das_matrix_api_name }} status: {{ after_versions[das_matrix_api_name].change_type | default('n/a') }}"
      - "{{ das_matrix_worker_name }} status: {{ after_versions[das_matrix_worker_name].change_type | default('n/a') }}"

- name: Assert update/removal detection
  ansible.builtin.assert:
    that:
      - after_versions[das_matrix_api_name].change_type == 'updated'
      - after_versions[das_matrix_worker_name].change_type == 'removed'
    fail_msg: "Matrix-only scope should detect updated and removed services"

- name: Cache updated history for downstream scenarios
  ansible.builtin.set_fact:
    das_matrix_versions_updated: "{{ current_versions }}"
    das_matrix_history_updated: "{{ version_history }}"

- name: Recreate matrix-worker container for downstream scenarios
  community.docker.docker_container:
    name: "{{ das_matrix_worker_name }}"
    image: "alpine:3.19"
    command: "sleep 3600"
    state: started
    restart_policy: unless-stopped
    networks:
      - name: "{{ das_test_network }}"
