---
# SPDX-FileCopyrightText: 2025 MDAD project contributors
# SPDX-License-Identifier: AGPL-3.0-or-later

- name: Ensure retention prerequisites available
  ansible.builtin.assert:
    that:
      - das_matrix_versions_updated is defined
      - das_matrix_history_updated is defined
    fail_msg: "matrix_sequence must run before retention tests"

- name: Bump matrix API container image for retention test
  community.docker.docker_container:
    name: "{{ das_matrix_api_name }}"
    image: alpine:3.21
    command: "sleep 3600"
    state: started
    recreate: true
    pull: true
    networks:
      - name: "{{ das_test_network }}"
  tags: ["fixtures"]

- name: Run DAS with entry-count retention
  ansible.builtin.include_role:
    name: docker_ansible_summary
  vars:
    docker_ansible_summary_scope:
      - "{{ das_matrix_scope_pattern }}"
    docker_ansible_summary_history_max_entries: 1
    docker_ansible_summary_write_facts: false
    docker_ansible_summary_enable_discovery: true
    docker_ansible_summary_table_style_unicode: false
    docker_ansible_summary_ansible_local_override:
      matrix_versions: "{{ das_matrix_versions_updated }}"
      matrix_version_history: "{{ das_matrix_history_updated }}"

- name: Assert history trimmed to single entry
  ansible.builtin.assert:
    that:
      - version_history.changes | length == 1
    fail_msg: "Entry-count retention should limit history to the most recent change"
