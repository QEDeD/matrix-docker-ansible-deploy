---
# SPDX-FileCopyrightText: 2025 MDAD project contributors
# SPDX-License-Identifier: AGPL-3.0-or-later

# Validate notes output when metadata reports stopped containers
- name: Build container overrides for notes testing
  ansible.builtin.set_fact:
    das_notes_overrides:
      - name: "notes-api"
        image: "mock:latest"
        inspect:
          State:
            Status: "exited"
            Running: false
            RestartCount: 0
            ExitCode: 137
      - name: "notes-worker"
        image: "mock:latest"
        inspect:
          State:
            Status: "running"
            Running: true
            RestartCount: 2
            ExitCode: 0

- name: Summarise overrides with notes enabled
  ansible.builtin.include_role:
    name: docker_ansible_summary
  vars:
    docker_ansible_summary_container_overrides: "{{ das_notes_overrides }}"
    docker_ansible_summary_scope:
      - "notes-*"
    docker_ansible_summary_enable_discovery: false
    docker_ansible_summary_write_facts: false
    docker_ansible_summary_table_show_notes: true
    docker_ansible_summary_table_notes_include_state: true
    docker_ansible_summary_table_style_unicode: false

- name: Assert notes mention exited state
  ansible.builtin.assert:
    that:
      - after_versions['notes-api'].notes is search('exited')
      - after_versions['notes-worker'].notes is search('running')
    fail_msg: "Notes column should include metadata state for overridden containers"
