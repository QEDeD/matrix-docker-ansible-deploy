---
# SPDX-FileCopyrightText: 2025 MDAD project contributors
# SPDX-License-Identifier: AGPL-3.0-or-later
# Validate writing facts to a custom directory without sudo
- name: Ensure custom facts directory exists
  ansible.builtin.file:
    path: "{{ das_facts_dir }}"
    state: directory
    mode: '0755'

- name: Run DAS with fact writes enabled in custom directory
  ansible.builtin.include_role:
    name: docker_ansible_summary
  vars:
    docker_ansible_summary_scope:
      - "{{ das_matrix_scope_pattern }}"
    docker_ansible_summary_write_facts: true
    docker_ansible_summary_facts_dir: "{{ das_facts_dir }}"
    docker_ansible_summary_write_facts_become: false
    docker_ansible_summary_enable_discovery: true

- name: Assert fact files were written
  ansible.builtin.stat:
    path: "{{ das_facts_dir }}/{{ summary_versions_fact_file }}"
  register: das_versions_fact

- name: Validate history fact exists
  ansible.builtin.stat:
    path: "{{ das_facts_dir }}/{{ summary_history_fact_file }}"
  register: das_history_fact

- name: Validate display-state fact exists
  ansible.builtin.stat:
    path: "{{ das_facts_dir }}/{{ summary_display_state_fact_file }}"
  register: das_display_state_fact

- name: Assert custom fact files exist
  ansible.builtin.assert:
    that:
      - das_versions_fact.stat.exists
      - das_history_fact.stat.exists
      - das_display_state_fact.stat.exists
    fail_msg: "Fact files should be written to the custom directory"
