# SPDX-FileCopyrightText: 2025 MDAD project contributors
# SPDX-License-Identifier: AGPL-3.0-or-later
---
# Production Environment Test
# Run this on the actual production server to test the Docker Ansible Summary role

- name: Docker Ansible Summary - Production Test (Mock)
  hosts: localhost
  connection: local
  gather_facts: true
  vars:
    # Test in mock mode first (no Docker required)
    docker_summary_mock_mode: true
    docker_summary_mode: "status"
    docker_summary_display: true
    docker_summary_debug: true

  tasks:
    - name: "=== PRODUCTION TEST PHASE 1: MOCK MODE ==="
      ansible.builtin.debug:
        msg: "Testing table display logic with mock data (no Docker required)"

    - name: Execute role in mock mode
      ansible.builtin.include_role:
        name: custom/docker-ansible-summary

    - name: Verify mock mode results
      ansible.builtin.debug:
        msg: |
          === MOCK MODE RESULTS ===
          current_versions defined: {{ current_versions is defined }}
          current_versions count: {{ current_versions | default([]) | length }}
          after_versions defined: {{ after_versions is defined }}
          after_versions count: {{ after_versions | default([]) | length }}
          version_summary_table_lines defined: {{ version_summary_table_lines is defined }}
          table lines count: {{ version_summary_table_lines | default([]) | length }}

- name: Docker Ansible Summary - Production Test (Real Mode)
  hosts: localhost
  connection: local
  gather_facts: true
  vars:
    # Test in real mode (Docker required)
    docker_summary_mock_mode: false
    docker_summary_mode: "status"
    docker_summary_display: true
    docker_summary_debug: true

  tasks:
    - name: "=== PRODUCTION TEST PHASE 2: REAL MODE ==="
      ansible.builtin.debug:
        msg: "Testing with actual Docker environment"

    - name: Check Docker availability first
      ansible.builtin.command: docker --version
      register: docker_check
      failed_when: false
      changed_when: false

    - name: Skip real mode test if Docker unavailable
      ansible.builtin.debug:
        msg: "Docker not available - skipping real mode test"
      when: docker_check.rc != 0

    - name: Execute role in real mode
      ansible.builtin.include_role:
        name: custom/docker-ansible-summary
      when: docker_check.rc == 0

    - name: Verify real mode results
      ansible.builtin.debug:
        msg: |
          === REAL MODE RESULTS ===
          Docker available: {{ docker_check.rc == 0 }}
          current_versions defined: {{ current_versions is defined }}
          current_versions count: {{ current_versions | default([]) | length }}
          after_versions defined: {{ after_versions is defined }}
          after_versions count: {{ after_versions | default([]) | length }}
          version_summary_table_lines defined: {{ version_summary_table_lines is defined }}
          table lines count: {{ version_summary_table_lines | default([]) | length }}
      when: docker_check.rc == 0

    - name: Final test summary
      ansible.builtin.debug:
        msg: |
          === PRODUCTION TEST SUMMARY ===
          ✅ Mock mode test completed successfully
          {% if docker_check.rc == 0 %}
          {% if current_versions is defined and current_versions | length > 0 %}
          ✅ Real mode test completed successfully
          {% else %}
          ❌ Real mode test failed - no containers detected
          {% endif %}
          {% else %}
          ⚠️  Real mode test skipped - Docker not available
          {% endif %}

          NEXT STEPS:
          {% if docker_check.rc != 0 %}
          1. Install Docker on production server
          2. Start Matrix containers
          3. Re-run this test
          {% elif current_versions is not defined or current_versions | length == 0 %}
          1. Check Matrix container status: docker ps
          2. Start Matrix services if needed
          3. Verify container naming convention
          {% else %}
          ✅ Production environment ready for docker-ansible-summary role
          {% endif %}
