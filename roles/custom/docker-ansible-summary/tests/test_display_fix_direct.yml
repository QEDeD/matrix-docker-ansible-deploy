# SPDX-FileCopyrightText: 2025 MDAD project contributors
# SPDX-License-Identifier: AGPL-3.0-or-later
---
# Direct test of table display fix
- name: Direct table display test
  hosts: localhost
  gather_facts: true
  vars:
    matrix_table_service_width: 30
    matrix_table_version_width: 25
    matrix_table_status_width: 9
    matrix_table_style_unicode: false

    # Force the data that would normally come from Docker
    current_versions:
      matrix-synapse: "synapse:v1.95.1"
      matrix-postgres: "postgres:15.4-alpine"
      matrix-redis: "redis:7.2.3-alpine"
    after_versions:
      matrix-synapse:
        current: "synapse:v1.96.0"
        previous: "synapse:v1.95.1"
        status: "UPDATED"
      matrix-postgres:
        current: "postgres:15.5-alpine"
        previous: "postgres:15.4-alpine"
        status: "UPDATED"
      matrix-redis:
        current: "redis:7.2.3-alpine"
        previous: "redis:7.2.3-alpine"
        status: "UNCHANGED"

  tasks:
    # Manually trigger just the table display section
    - name: Set table characters (ASCII)
      ansible.builtin.set_fact:
        h_line: "-"
        v_line: "|"
        tl_corner: "+"
        tr_corner: "+"
        bl_corner: "+"
        br_corner: "+"
        t_down: "+"
        t_up: "+"
        t_right: "+"
        t_left: "+"
        cross: "+"
        double_h_line: "="
        double_cross: "+"

    - name: Create table header
      ansible.builtin.set_fact:
        service_col_width: "{{ matrix_table_service_width | default(30) | int }}"
        version_col_width: "{{ matrix_table_version_width | default(25) | int }}"
        status_col_width: "{{ matrix_table_status_width | default(9) | int }}"
        service_border_width: "{{ (matrix_table_service_width | default(30) | int) + 2 }}"
        version_border_width: "{{ (matrix_table_version_width | default(25) | int) + 2 }}"
        status_border_width: "{{ (matrix_table_status_width | default(9) | int) + 2 }}"

    - name: Build table lines with configurable widths
      ansible.builtin.set_fact:
        top_line: >-
          {{ tl_corner }}{{ h_line * (service_border_width | int) }}{{ t_down }}
          {{ h_line * (version_border_width | int) }}{{ t_down }}
          {{ h_line * (version_border_width | int) }}{{ t_down }}
          {{ h_line * (status_border_width | int) }}{{ tr_corner }}
        header_row: >-
          {{ v_line }} {{ ('SERVICE/CONTAINER' + ' ' * (service_col_width | int))[: service_col_width | int] }} {{ v_line }}
          {{ ('VERSION BEFORE' + ' ' * (version_col_width | int))[: version_col_width | int] }} {{ v_line }}
          {{ ('VERSION AFTER' + ' ' * (version_col_width | int))[: version_col_width | int] }} {{ v_line }}
          {{ ('STATUS' + ' ' * (status_col_width | int))[: status_col_width | int] }} {{ v_line }}
        header_sep: >-
          {{ t_right }}{{ double_h_line * (service_border_width | int) }}{{ double_cross }}
          {{ double_h_line * (version_border_width | int) }}{{ double_cross }}
          {{ double_h_line * (version_border_width | int) }}{{ double_cross }}
          {{ double_h_line * (status_border_width | int) }}{{ t_left }}
        bottom_line: >-
          {{ bl_corner }}{{ h_line * (service_border_width | int) }}{{ t_up }}
          {{ h_line * (version_border_width | int) }}{{ t_up }}
          {{ h_line * (version_border_width | int) }}{{ t_up }}
          {{ h_line * (status_border_width | int) }}{{ br_corner }}

    - name: Generate table content
      ansible.builtin.set_fact:
        table_rows: []

    - name: Add table rows
      ansible.builtin.set_fact:
        table_rows: "{{ table_rows + [table_row] }}"
      vars:
        table_row: >-
          {{ v_line + ' ' +
             ((item.key | truncate(service_col_width | int, true)) + ' ' * (service_col_width | int))[:service_col_width | int] + ' ' +
             v_line + ' ' +
             (((item.value.previous | default('-') | string | truncate(version_col_width | int, true)) +
             ' ' * (version_col_width | int))[:version_col_width | int]) + ' ' +
             v_line + ' ' +
             (((item.value.current | string | truncate(version_col_width | int, true)) +
             ' ' * (version_col_width | int))[:version_col_width | int]) + ' ' +
             v_line + ' ' +
             ((item.value.status + ' ' * (status_col_width | int))[:status_col_width | int]) + ' ' +
             v_line }}
      loop: "{{ after_versions | dict2items | sort(attribute='key') }}"

    - name: Build complete table as list
      ansible.builtin.set_fact:
        version_summary_table_lines: >-
          {{ ['MATRIX VERSION CHANGES - ' + ansible_date_time.iso8601, ''] +
             [top_line, header_row, header_sep] +
             table_rows +
             [bottom_line] }}

    # THIS IS THE CRITICAL TEST - the fixed display method
    - name: Display formatted table (FIXED VERSION)
      ansible.builtin.debug:
        msg: "{{ version_summary_table_lines }}"
      when:
        - current_versions | length > 0
        - after_versions | length > 0

    - name: Verify the fix worked
      ansible.builtin.debug:
        msg: |
          ðŸŽ¯ TABLE DISPLAY FIX VERIFICATION:

          âœ… The table should be visible above this message
          âœ… Changed from: ansible.builtin.shell (invisible output)
          âœ… Changed to: ansible.builtin.debug (visible output)

          This fixes the major problem where the table was generated
          but never displayed to Matrix administrators!
