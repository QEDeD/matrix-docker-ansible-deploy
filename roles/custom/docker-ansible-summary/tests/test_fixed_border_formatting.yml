---
# Test fixed border formatting

- name: Test fixed table border formatting
  hosts: localhost
  gather_facts: true
  vars:
    matrix_table_service_width: 30
    matrix_table_version_width: 25
    matrix_table_status_width: 9
    matrix_table_style_unicode: false

    # Mock data to test border formatting
    after_versions:
      matrix-synapse:
        current: "synapse:v1.131.0"
        previous: "synapse:v1.130.0"
        status: "UPDATED"
      matrix-postgres:
        current: "postgres:16-alpine"
        previous: "postgres:15-alpine"
        status: "UPDATED"

  tasks:
    - name: Set table characters (ASCII)
      ansible.builtin.set_fact:
        h_line: "-"
        v_line: "|"
        tl_corner: "+"
        tr_corner: "+"
        bl_corner: "+"
        br_corner: "+"
        t_down: "+"
        t_up: "+"
        t_right: "+"
        t_left: "+"
        cross: "+"
        double_h_line: "="
        double_cross: "+"

    # Build table structure with configurable column widths (using fixed format)
    - name: Create table header
      ansible.builtin.set_fact:
        service_col_width: "{{ matrix_table_service_width | default(30) | int }}"
        version_col_width: "{{ matrix_table_version_width | default(25) | int }}"
        status_col_width: "{{ matrix_table_status_width | default(9) | int }}"
        service_border_width: "{{ (matrix_table_service_width | default(30) | int) + 2 }}"
        version_border_width: "{{ (matrix_table_version_width | default(25) | int) + 2 }}"
        status_border_width: "{{ (matrix_table_status_width | default(9) | int) + 2 }}"

    - name: Build table lines with fixed formatting (single line)
      ansible.builtin.set_fact:
        top_line: "{{ tl_corner }}{{ h_line * (service_border_width | int) }}{{ t_down }}{{ h_line * (version_border_width | int) }}{{ t_down }}{{ h_line * (version_border_width | int) }}{{ t_down }}{{ h_line * (status_border_width | int) }}{{ tr_corner }}"
        header_row: "{{ v_line }} {{ ('SERVICE/CONTAINER' + ' ' * (service_col_width | int))[: service_col_width | int] }} {{ v_line }} {{ ('VERSION BEFORE' + ' ' * (version_col_width | int))[: version_col_width | int] }} {{ v_line }} {{ ('VERSION AFTER' + ' ' * (version_col_width | int))[: version_col_width | int] }} {{ v_line }} {{ ('STATUS' + ' ' * (status_col_width | int))[: status_col_width | int] }} {{ v_line }}"
        header_sep: "{{ t_right }}{{ double_h_line * (service_border_width | int) }}{{ double_cross }}{{ double_h_line * (version_border_width | int) }}{{ double_cross }}{{ double_h_line * (version_border_width | int) }}{{ double_cross }}{{ double_h_line * (status_border_width | int) }}{{ t_left }}"
        bottom_line: "{{ bl_corner }}{{ h_line * (service_border_width | int) }}{{ t_up }}{{ h_line * (version_border_width | int) }}{{ t_up }}{{ h_line * (version_border_width | int) }}{{ t_up }}{{ h_line * (status_border_width | int) }}{{ br_corner }}"

    - name: Debug fixed lines with character counts
      ansible.builtin.debug:
        msg: |
          top_line length: {{ top_line | length }}
          top_line: "{{ top_line }}"
          header_row length: {{ header_row | length }}
          header_row: "{{ header_row }}"
          header_sep length: {{ header_sep | length }}
          header_sep: "{{ header_sep }}"
          bottom_line length: {{ bottom_line | length }}
          bottom_line: "{{ bottom_line }}"

    # Generate table rows
    - name: Generate table content
      ansible.builtin.set_fact:
        table_rows: []

    - name: Add table rows (using existing format - should be fine)
      ansible.builtin.set_fact:
        table_rows: "{{ table_rows + [table_row] }}"
      vars:
        table_row: >-
          {{ v_line + ' ' +
             ((item.key | truncate(service_col_width | int, true)) + ' ' * (service_col_width | int))[:service_col_width | int] + ' ' +
             v_line + ' ' +
             (((item.value.previous | default('-') | string | truncate(version_col_width | int, true)) +
             ' ' * (version_col_width | int))[:version_col_width | int]) + ' ' +
             v_line + ' ' +
             (((item.value.current | string | truncate(version_col_width | int, true)) +
             ' ' * (version_col_width | int))[:version_col_width | int]) + ' ' +
             v_line + ' ' +
             ((item.value.status + ' ' * (status_col_width | int))[:status_col_width | int]) + ' ' +
             v_line }}
      loop: "{{ after_versions | dict2items | sort(attribute='key') }}"

    - name: Debug table rows with lengths
      ansible.builtin.debug:
        msg: |
          Row {{ ansible_loop.index0 }}: length {{ item | length }}
          "{{ item }}"
      loop: "{{ table_rows }}"
      loop_control:
        extended: true

    # Create complete table output as list of lines
    - name: Build complete table as list
      ansible.builtin.set_fact:
        version_summary_table_lines: >-
          {{ ['MATRIX VERSION CHANGES - FIXED FORMATTING TEST', ''] +
             [top_line, header_row, header_sep] +
             table_rows +
             [bottom_line, '', 'Test complete - borders should be perfect'] }}

    # Display table using debug for visible output
    - name: Display formatted table
      ansible.builtin.debug:
        msg: "{{ version_summary_table_lines }}"
