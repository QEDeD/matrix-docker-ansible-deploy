---
# Debug version of Docker Ansible Summary Role for Production Troubleshooting
# This adds extensive debug output to identify exactly where the logic fails
#
# Usage: ansible-playbook -i inventory/hosts debug_docker_summary.yml -vvv

- name: Docker Ansible Summary - Debug Mode
  hosts: matrix_servers
  gather_facts: true
  vars:
    docker_summary_display: true
    debug_output: true

  tasks:
    - name: "ðŸ” DEBUG: Starting Docker Ansible Summary with extensive logging"
      ansible.builtin.debug:
        msg:
          - "======== MATRIX VERSION SUMMARY DEBUG MODE ========"
          - "Timestamp: {{ ansible_date_time.iso8601 }}"
          - "Host: {{ inventory_hostname }}"
          - "Debug mode: ENABLED"

    # Step 1: Environment validation
    - name: "ðŸ” DEBUG: Check Docker availability"
      ansible.builtin.command: which docker
      register: docker_check
      failed_when: false
      changed_when: false

    - name: "ðŸ” DEBUG: Docker availability result"
      ansible.builtin.debug:
        msg:
          - "Docker command found: {{ 'YES' if docker_check.rc == 0 else 'NO' }}"
          - "Docker path: {{ docker_check.stdout | default('Not found') }}"
          - "Return code: {{ docker_check.rc }}"

    - name: "ðŸ” DEBUG: Test Docker access"
      ansible.builtin.shell: |
        set -o pipefail
        docker ps --format "{{ '{{' }}.Names{{ '}}' }}" | head -5
      args:
        executable: /bin/bash
      register: docker_access_test
      failed_when: false
      changed_when: false
      when: docker_check.rc == 0

    - name: "ðŸ” DEBUG: Docker access result"
      ansible.builtin.debug:
        msg:
          - "Docker access successful: {{ 'YES' if docker_access_test.rc == 0 else 'NO' }}"
          - "Error (if any): {{ docker_access_test.stderr | default('None') }}"
      when: docker_check.rc == 0

    # Step 2: Container detection (exact role logic)
    - name: "ðŸ” DEBUG: Get current container versions (EXACT ROLE LOGIC)"
      ansible.builtin.shell: |
        set -o pipefail
        docker ps --filter "name={{ (docker_summary_scope | regex_replace('\\*$', '')) }}" --format "{{ "{{" }}.Names{{ "}}" }}" | while read container; do
          if [ -n "$container" ]; then
            image=$(docker inspect --format='{{ "{{" }}.Config.Image{{ "}}" }}' "$container" 2>/dev/null || echo "unknown")
            echo "$container:$image"
          fi
        done
      args:
        executable: /bin/bash
      register: current_versions_debug
      failed_when: false
      changed_when: false
      when: docker_check.rc == 0

    - name: "ðŸ” DEBUG: Current versions detection result"
      ansible.builtin.debug:
        msg:
          - "Command successful: {{ 'YES' if current_versions_debug.rc == 0 else 'NO' }}"
          - "Raw output lines: {{ current_versions_debug.stdout_lines | default([]) | length }}"
          - "Raw output: {{ current_versions_debug.stdout_lines | default(['No output']) }}"
          - "Stderr: {{ current_versions_debug.stderr | default('None') }}"
      when: current_versions_debug is defined

    # Step 3: Process container data (exact role logic)
    - name: "ðŸ” DEBUG: Process current versions into structured data"
      ansible.builtin.set_fact:
        current_versions: >-
          {{ current_versions_debug.stdout_lines | default([]) |
             select('match', '.+:.+') |
             map('regex_replace', '^(.+):(.+)$', '{"name": "\1", "image": "\2"}') |
             map('from_json') | list }}
      when:
        - current_versions_debug is defined
        - current_versions_debug.rc == 0

    - name: "ðŸ” DEBUG: Structured current_versions result"
      ansible.builtin.debug:
        msg:
          - "current_versions defined: {{ current_versions is defined }}"
          - "current_versions length: {{ current_versions | default([]) | length }}"
          - "current_versions content: {{ current_versions | default([]) }}"

    # Step 4: Set after_versions (role logic)
    - name: "ðŸ” DEBUG: Set after_versions (role logic simulation)"
      ansible.builtin.set_fact:
        after_versions: "{{ current_versions | default([]) }}"
      when: current_versions is defined

    - name: "ðŸ” DEBUG: after_versions result"
      ansible.builtin.debug:
        msg:
          - "after_versions defined: {{ after_versions is defined }}"
          - "after_versions length: {{ after_versions | default([]) | length }}"

    # Step 5: Test table display conditions
    - name: "ðŸ” DEBUG: Table display condition evaluation"
      ansible.builtin.debug:
        msg:
          - "=== TABLE DISPLAY CONDITIONS ==="
          - "current_versions | length: {{ current_versions | default([]) | length }}"
          - "after_versions | length: {{ after_versions | default([]) | length }}"
          - "Condition 1 (current_versions | length > 0): {{ (current_versions | default([]) | length > 0) }}"
          - "Condition 2 (after_versions | length > 0): {{ (after_versions | default([]) | length > 0) }}"
          - "Combined condition: {{ (current_versions | default([]) | length > 0) and (after_versions | default([]) | length > 0) }}"
          - "EXPECTED: Table display task {{ 'WILL RUN' if
               ((current_versions | default([]) | length > 0) and
               (after_versions | default([]) | length > 0)) else 'WILL BE SKIPPED' }}"

    # Step 6: Build table (exact role logic)
    - name: "ðŸ” DEBUG: Build version summary table"
      ansible.builtin.set_fact:
        version_summary_table_lines: >-
          {{ ['â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”'] +
             ['â”‚ SERVICE                    â”‚ VERSION                                 â”‚ STATUS   â”‚'] +
             ['â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤'] +
             (current_versions | default([]) |
              map('extract', {}, 'name') |
              map('regex_replace', '^matrix-(.+)', '\\1') |
              map('truncate', 26, True, '') |
              map('regex_replace', '^(.*)$', 'â”‚ \\1' + (' ' * (26 - ('\\1' | length))) + ' â”‚ VERSION_HERE' + (' ' * 28) + ' â”‚ CURRENT  â”‚') |
              list) +
             ['â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜'] }}
      when:
        - current_versions is defined
        - current_versions | length > 0
        - after_versions is defined
        - after_versions | length > 0

    - name: "ðŸ” DEBUG: Table building result"
      ansible.builtin.debug:
        msg:
          - "Table building attempted: {{ 'YES' if ((current_versions | default([]) | length > 0) and (after_versions | default([]) | length > 0)) else 'NO' }}"
          - "version_summary_table_lines defined: {{ version_summary_table_lines is defined }}"
          - "Table lines count: {{ version_summary_table_lines | default([]) | length }}"

    # Step 7: Execute table display (exact role logic)
    - name: "ðŸ” DEBUG: Display formatted table (EXACT ROLE TASK)"
      ansible.builtin.shell: |
        echo -e '{{ version_summary_table_lines | join("\\n") }}'
      changed_when: false
      when:
        - current_versions | default([]) | length > 0
        - after_versions | default([]) | length > 0

    - name: "ðŸ” DEBUG: Table display task execution status"
      ansible.builtin.debug:
        msg:
          - "Table display task executed: {{ 'YES' if
               ((current_versions | default([]) | length > 0) and
               (after_versions | default([]) | length > 0)) else 'NO - CONDITIONS NOT MET' }}"

    # Step 8: Alternative simple table for debugging
    - name: "ðŸ” DEBUG: Simple fallback table (if conditions allow)"
      ansible.builtin.shell: |
        echo "=== MATRIX VERSION SUMMARY DEBUG ==="
        echo "Containers found: {{ current_versions | default([]) | length }}"
        {% for container in current_versions | default([]) %}
        echo "{{ container.name }}: {{ container.image }}"
        {% endfor %}
        echo "=== END DEBUG TABLE ==="
      changed_when: false
      when: current_versions | default([]) | length > 0

    # Step 9: Final diagnosis
    - name: "ðŸ” DEBUG: FINAL DIAGNOSIS"
      ansible.builtin.debug:
        msg:
          - "======== PRODUCTION DIAGNOSIS COMPLETE ========"
          - "Docker Available: {{ 'YES' if docker_check.rc == 0 else 'NO' }}"
          - "Matrix Containers Found: {{ current_versions | default([]) | length }}"
          - "Table Display Conditions Met: {{ (current_versions | default([]) | length > 0) and (after_versions | default([]) | length > 0) }}"
          - ""
          - "CONCLUSION:"
          - "{{ 'PROBLEM: Docker not available - install Docker and start Matching containers' if docker_check.rc != 0 else '' }}"
          - "{{ 'PROBLEM: No Matching containers found - check MDAD deployment status' if
               (docker_check.rc == 0 and (current_versions | default([]) | length == 0)) else '' }}"
          - "{{ 'SUCCESS: Environment ready, table should display normally' if
               ((current_versions | default([]) | length > 0) and
               (after_versions | default([]) | length > 0)) else '' }}"
          - ""
          - "Next: Run actual docker-ansible-summary role and compare results"
