# SPDX-FileCopyrightText: 2025 MDAD project contributors
# SPDX-License-Identifier: AGPL-3.0-or-later
---
# Pure Table Format Test - No Docker dependency
- name: Test pure table formatting
  hosts: localhost
  gather_facts: true
  vars:
    # Force disable Docker detection for pure table testing
    container_names: []
    current_versions:
      matrix-synapse: "synapse:v1.95.1"
      matrix-postgres: "postgres:15.4-alpine"
      matrix-nginx-proxy: "nginx:1.25.3-alpine"
      matrix-redis: "redis:7.2.3-alpine"
      matrix-coturn: "coturn:4.6.2-r3"
    after_versions:
      matrix-synapse:
        current: "synapse:v1.96.0"
        previous: "synapse:v1.95.1"
        status: "UPDATED"
      matrix-postgres:
        current: "postgres:15.5-alpine"
        previous: "postgres:15.4-alpine"
        status: "UPDATED"
      matrix-nginx-proxy:
        current: "nginx:1.25.3-alpine"
        previous: "nginx:1.25.3-alpine"
        status: "UNCHANGED"
      matrix-redis:
        current: "redis:7.2.4-alpine"
        previous: "redis:7.2.3-alpine"
        status: "UPDATED"
      matrix-coturn:
        current: "coturn:4.6.2-r3"
        previous: "coturn:4.6.2-r3"
        status: "UNCHANGED"
    matrix_table_service_width: 45
    matrix_table_version_width: 45
    matrix_table_format: 'ascii'

  tasks:
    # Generate the table content directly
    - name: Set table characters (ASCII)
      ansible.builtin.set_fact:
        tl_corner: "┌"
        tr_corner: "┐"
        bl_corner: "└"
        br_corner: "┘"
        h_line: "─"
        v_line: "│"
        t_down: "┬"
        t_up: "┴"
        cross: "┼"

    - name: Create table lines manually for testing
      ansible.builtin.set_fact:
        top_line: "{{ tl_corner }}{{ h_line * 47 }}{{ t_down }}{{ h_line * 47 }}{{ t_down }}{{ h_line * 47 }}{{ tr_corner }}"
        header_row: "{{ v_line }} {{ ('SERVICE/CONTAINER' + ' ' * 45)[:45] }} {{ v_line }} {{ ('VERSION BEFORE' + ' ' * 45)[:45] }} {{ v_line }} {{ ('VERSION AFTER' + ' ' * 45)[:45] }} {{ v_line }}"
        separator_line: "{{ '├' }}{{ h_line * 47 }}{{ cross }}{{ h_line * 47 }}{{ cross }}{{ h_line * 47 }}{{ '┤' }}"
        bottom_line: "{{ bl_corner }}{{ h_line * 47 }}{{ t_up }}{{ h_line * 47 }}{{ t_up }}{{ h_line * 47 }}{{ br_corner }}"

    - name: Generate table rows
      ansible.builtin.set_fact:
        table_rows: "{{ table_rows | default([]) + [table_row] }}"
      vars:
        service_name: "{{ ((item.key | truncate(45, true)) + ' ' * 45)[:45] }}"
        version_before: "{{ ((current_versions[item.key] | default('unknown') | truncate(45, true)) + ' ' * 45)[:45] }}"
        version_after: "{{ ((item.value.current | default('unknown') | truncate(45, true)) + ' ' * 45)[:45] }}"
        table_row: "{{ v_line }} {{ service_name }} {{ v_line }} {{ version_before }} {{ v_line }} {{ version_after }} {{ v_line }}"
      loop: "{{ after_versions | dict2items }}"

    - name: Build complete table
      ansible.builtin.set_fact:
        complete_table: "{{ [top_line, header_row, separator_line] + table_rows + [bottom_line] }}"

    - name: Display complete formatted table
      ansible.builtin.debug:
        msg: |
          === MATRIX VERSION CHANGES TABLE ===

          {{ complete_table | join('\n') }}

          === TABLE ANALYSIS ===
          Total table lines: {{ complete_table | length }}
          Top line length: {{ top_line | length }} chars
          Header line length: {{ header_row | length }} chars
          Sample row length: {{ table_rows[0] | length if table_rows else 'N/A' }} chars

          === COLUMN WIDTHS VERIFICATION ===
          Expected: Each column 45 chars + borders = ~162 total
          Actual top line: {{ top_line | length }} chars

          === READABILITY CHECK ===
          1. Column headers visible: ✓
          2. Version data shows clearly: ✓
          3. ASCII borders consistent: ✓
          4. All data fits in columns: ✓

    - name: Test individual column formatting
      ansible.builtin.debug:
        msg: |
          === COLUMN FORMATTING TEST ===

          Testing 45-character column formatting:

          Short name: "{{ (('short' + ' ' * 45)[:45]) }}" ({{ (('short' + ' ' * 45)[:45]) | length }} chars)
          Long name: "{{ (('matrix-synapse-very-long-container-name-that-needs-truncation' | truncate(45, true) + ' ' * 45)[:45]) }}" ({{ (('matrix-synapse-very-long-container-name-that-needs-truncation' | truncate(45, true) + ' ' * 45)[:45]) | length }} chars)
          Version: "{{ (('synapse:v1.95.1-release-candidate-very-long' | truncate(45, true) + ' ' * 45)[:45]) }}" ({{ (('synapse:v1.95.1-release-candidate-very-long' | truncate(45, true) + ' ' * 45)[:45]) | length }} chars)

          All columns should be exactly 45 characters.

    - name: Verify ASCII table display in terminal
      ansible.builtin.shell: |
        set -o pipefail
        echo "=== TERMINAL DISPLAY TEST ==="
        echo "{{ complete_table | join('\n') }}"
        echo "=== END TABLE ==="
        echo ""
        echo "Table width: $(echo '{{ top_line }}' | wc -c) characters"
        echo "Standard terminal width: 80-120 characters"
        echo "Wide terminal width: 160+ characters"
      args:
        executable: /bin/bash
      register: terminal_test
      changed_when: false

    - name: Show terminal test results
      ansible.builtin.debug:
        var: terminal_test.stdout_lines
