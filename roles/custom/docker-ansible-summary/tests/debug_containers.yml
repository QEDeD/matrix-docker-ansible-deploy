# SPDX-FileCopyrightText: 2025 MDAD project contributors
# SPDX-License-Identifier: AGPL-3.0-or-later
---
- name: Debug Docker Ansible Summary
  hosts: "{{ target_host | default('matrix.thewrt.com') }}"
  gather_facts: true
  vars:
    docker_summary_scope: "matrix-*"
  tasks:
    - name: Test container detection command
      ansible.builtin.shell: |
        set -o pipefail
        docker ps --filter "name={{ (docker_summary_scope | regex_replace('\\*$', '')) | regex_escape }}" \
          --format "{{ "{{" }}.Names{{ "}}" }}:{{ "{{" }}.Image{{ "}}" }}" | \
          sort || echo "DOCKER_ERROR"
      register: container_test
      changed_when: false
      args:
        executable: /bin/bash

    - name: Show container detection results
      ansible.builtin.debug:
        var: container_test.stdout_lines

    - name: Initialize test variables
      ansible.builtin.set_fact:
        current_versions: {}
        after_versions: {}

    - name: Process container versions
      ansible.builtin.set_fact:
        current_versions: "{{ current_versions | combine({item.split(':')[0]: item.split(':')[1:] | join(':')}) }}"
      loop: "{{ container_test.stdout_lines | default([]) }}"
      when:
        - container_test.stdout_lines is defined
        - container_test.stdout_lines | length > 0
        - "':' in item"

    - name: Show processed current_versions
      ansible.builtin.debug:
        var: current_versions

    - name: Check if current_versions has content
      ansible.builtin.debug:
        msg: "current_versions length: {{ current_versions | length }}"

    - name: Test status_check_mode detection
      ansible.builtin.set_fact:
        status_check_mode: "{{ ansible_run_tags is defined and ('docker-ansible-summary' in ansible_run_tags) and (ansible_run_tags | length == 1) }}"

    - name: Show status_check_mode and ansible_run_tags
      ansible.builtin.debug:
        msg: |
          ansible_run_tags: {{ ansible_run_tags | default('undefined') }}
          status_check_mode: {{ status_check_mode }}

    - name: Test after_versions building (status mode)
      ansible.builtin.set_fact:
        after_versions: "{{ after_versions | combine({item: {'current': current_versions[item], 'previous': current_versions[item], 'status': 'CURRENT'}}) }}"
      loop: "{{ current_versions.keys() | list }}"
      when:
        - current_versions | length > 0
        - status_check_mode | default(false) | bool

    - name: Show after_versions result
      ansible.builtin.debug:
        msg: "after_versions length: {{ after_versions | length }}"
