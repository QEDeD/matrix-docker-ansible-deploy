# SPDX-FileCopyrightText: 2025 MDAD project contributors
# SPDX-License-Identifier: AGPL-3.0-or-later
---
- name: Docker Ansible Summary - Production Diagnostic
  hosts: matrix_servers
  gather_facts: true
  vars:
    docker_summary_scope: "{{ docker_summary_scope | default('matrix-*') }}"
    docker_summary_display: false
    docker_summary_write_facts: false
    docker_summary_enable_discovery: true
  tasks:
    - name: Report diagnostic context
      ansible.builtin.debug:
        msg: |
          Docker Ansible Summary diagnostics
          Host: {{ inventory_hostname }}
          Scope: {{ docker_summary_scope }}
          Python: {{ ansible_python.version.major }}.{{ ansible_python.version.minor }}

    - name: Check Docker SDK availability
      ansible.builtin.command: python3 -c "import docker"
      register: docker_sdk_check
      changed_when: false
      failed_when: false

    - name: Display Docker SDK status
      ansible.builtin.debug:
        msg: >-
          Docker SDK import {{ 'succeeded' if docker_sdk_check.rc == 0 else 'FAILED (install python3-docker)' }}

    - name: Probe Docker daemon connectivity
      community.docker.docker_host_info:
        containers: true
        verbose_output: false
      register: docker_host_info_result
      changed_when: false
      failed_when: false
      when: docker_sdk_check.rc == 0

    - name: Summarise container discovery
      ansible.builtin.debug:
        msg: >-
          Detected {{ docker_host_info_result.containers | default([]) | length }} containers matching {{ docker_summary_scope }}
      when: docker_sdk_check.rc == 0

    - name: Execute Docker Ansible Summary role in diagnostic mode
      ansible.builtin.include_role:
        name: custom/docker-ansible-summary
      vars:
        docker_summary_display: true
        docker_summary_write_facts: false
        docker_summary_mock_mode: false
        docker_summary_enable_discovery: true
  tags:
    - docker-ansible-summary
    - diagnostics
