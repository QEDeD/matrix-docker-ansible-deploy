---
# SPDX-FileCopyrightText: 2025 MDAD project contributors
# SPDX-License-Identifier: AGPL-3.0-or-later

- name: Override DAS scope for matrix containers (status mode)
  ansible.builtin.set_fact:
    docker_summary_scope: "{{ das_matrix_scope_pattern }}"

- name: Run DAS in status-only mode
  ansible.builtin.include_role:
    name: custom/docker-ansible-summary
  vars:
    docker_summary_scope:
      - "{{ das_matrix_scope_pattern }}"
    docker_summary_mode: status
    docker_summary_write_facts: false
    docker_summary_enable_discovery: true
    docker_summary_table_style_unicode: false
    docker_summary_ansible_local_override: {}

- name: Assert status mode reports current services without changes
  ansible.builtin.assert:
    that:
      - (after_versions | dict2items | map(attribute='value') | map(attribute='change_type') | unique | list) == ['status']
    fail_msg: "Status-only mode should mark every service as CURRENT/STATUS"
