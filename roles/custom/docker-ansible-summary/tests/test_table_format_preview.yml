---
# Test the new table format logic without requiring sudo
- name: Test New Table Format Logic
  hosts: localhost
  connection: local
  gather_facts: true
  vars:
    matrix_table_style_unicode: false
    matrix_container_prefix: "matrix-"

  tasks:
    # Simulate the new table structure
    - name: Test table width calculations
      ansible.builtin.set_fact:
        h_line: "-"
        v_line: "|"
        tl_corner: "+"
        tr_corner: "+"
        bl_corner: "+"
        br_corner: "+"
        t_down: "+"
        t_up: "+"
        t_right: "+"
        t_left: "+"
        cross: "+"
        double_h_line: "="
        double_cross: "+"

    # Test new 45-character column widths
    - name: Create table header with new widths
      ansible.builtin.set_fact:
        top_line: "{{ tl_corner }}{{ h_line * 47 }}{{ t_down }}{{ h_line * 47 }}{{ t_down }}{{ h_line * 47 }}{{ t_down }}{{ h_line * 11 }}{{ tr_corner }}"
        header_row: "{{ v_line }} {{ ('SERVICE/CONTAINER' + ' ' * 45)[:45] }} {{ v_line }} {{ ('VERSION BEFORE' + ' ' * 45)[:45] }} {{ v_line }} {{ ('VERSION AFTER' + ' ' * 45)[:45] }} {{ v_line }} {{ ('STATUS' + ' ' * 9)[:9] }} {{ v_line }}"
        header_sep: "{{ t_right }}{{ double_h_line * 47 }}{{ double_cross }}{{ double_h_line * 47 }}{{ double_cross }}{{ double_h_line * 47 }}{{ double_cross }}{{ double_h_line * 11 }}{{ t_left }}"
        bottom_line: "{{ bl_corner }}{{ h_line * 47 }}{{ t_up }}{{ h_line * 47 }}{{ t_up }}{{ h_line * 47 }}{{ t_up }}{{ h_line * 11 }}{{ br_corner }}"

    # Test sample data with new version extraction format
    - name: Test sample data row
      ansible.builtin.set_fact:
        sample_container: "matrix-synapse"
        sample_version_before: "synapse:v1.95.1"
        sample_version_after: "synapse:v1.96.1"
        sample_status: "UPDATED"

    - name: Create sample table row with 45-character columns
      ansible.builtin.set_fact:
        sample_row: >-
          {{ v_line + ' ' +
             ((sample_container + ' ' * 45)[:45]) + ' ' +
             v_line + ' ' +
             ((sample_version_before + ' ' * 45)[:45]) + ' ' +
             v_line + ' ' +
             ((sample_version_after + ' ' * 45)[:45]) + ' ' +
             v_line + ' ' +
             ((sample_status + ' ' * 9)[:9]) + ' ' +
             v_line }}

    # Display the new table format
    - name: Display new table format preview
      ansible.builtin.debug:
        msg: |

          ‚úÖ NEW TABLE FORMAT (45-character columns):
          {{ top_line }}
          {{ header_row }}
          {{ header_sep }}
          {{ sample_row }}
          {{ bottom_line }}

          üìè Column widths:
          - SERVICE/CONTAINER: 45 characters (was 30)
          - VERSION BEFORE: 45 characters (was 30)
          - VERSION AFTER: 45 characters (was 30)
          - STATUS: 9 characters (unchanged)

          üìã Total table width: ~162 characters (including borders)

          üéØ Version format examples:
          - synapse:v1.96.1 (smart extraction from ghcr.io/element-hq/synapse:v1.96.1)
          - postgres:15.4-alpine (from postgres:15.4-alpine)
          - nginx:1.25.3-alpine (from nginx:1.25.3-alpine)

          ‚úÖ All improvements implemented:
          - Hybrid version extraction (docker ps + docker inspect)
          - Smart version parsing (clean image:version format)
          - Wider columns (45 vs 30 characters)
          - Fixed Docker template syntax
          - Updated all supporting files
