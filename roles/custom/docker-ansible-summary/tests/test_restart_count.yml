# SPDX-FileCopyrightText: 2025 MDAD project contributors
# SPDX-License-Identifier: AGPL-3.0-or-later

---
- name: Validate restart count capture
  hosts: localhost
  gather_facts: true
  vars:
    docker_summary_write_facts: false
    docker_summary_container_overrides:
      - name: "service-restart"
        image: "example/service:1.0"
        inspect:
          Image: "example/service:1.0"
          RepoDigests: []
          Created: "2025-01-01T00:00:00Z"
          RestartCount: 5
          State:
            Status: "running"
            Running: true
            StartedAt: "2025-01-01T00:00:00Z"
            FinishedAt: ""
            ExitCode: 0
            RestartCount: 5
  tasks:
    - name: Run DAS for restart-count scenario
      ansible.builtin.include_role:
        name: custom/docker-ansible-summary
      vars:
        docker_summary_scope: "service-restart"

    - name: Assert restart count propagated into metadata
      ansible.builtin.assert:
        that:
          - after_versions["service-restart"].metadata.current.state.restart_count == 5
        fail_msg: "Restart count did not propagate into metadata"
