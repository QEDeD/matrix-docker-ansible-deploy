# SPDX-FileCopyrightText: 2025 MDAD project contributors
# SPDX-License-Identifier: AGPL-3.0-or-later

---
- name: Resolve history view configuration
  ansible.builtin.set_fact:
    summary_history_fact_file: "{{ docker_summary_history_fact_file | default('matrix_version_history.fact') }}"
    summary_retention_days: "{{ docker_summary_retention_days | default(365) | int }}"
    summary_service_filter: "{{ docker_summary_service_filter | default(service_filter | default('')) }}"
    summary_view_mode: "{{ docker_summary_view_mode | default(view_mode | default('changes')) }}"

- name: Derive history fact key
  ansible.builtin.set_fact:
    summary_history_fact_key: "{{ summary_history_fact_file | regex_replace('\\.fact$', '') }}"

- name: Resolve cached local facts
  ansible.builtin.set_fact:
    summary_local_facts: "{{ (docker_summary_ansible_local_override if docker_summary_ansible_local_override is not none else ansible_local) | default({}) }}"

- name: Load version history snapshot
  ansible.builtin.set_fact:
    version_history: "{{ summary_local_facts | docker_summary_fact(summary_history_fact_key) | docker_summary_ensure_history }}"

# Apply date-based retention cleanup when reading history
- name: Calculate cutoff date for retention cleanup (Linux)
  ansible.builtin.command: date -u -d "{{ summary_retention_days }} days ago" +"%Y-%m-%d %H:%M:%S"
  register: linux_history_cutoff
  changed_when: false
  failed_when: false
  when:
    - summary_retention_days | int > 0
    - ansible_system == "Linux"

- name: Calculate cutoff date for retention cleanup (BSD/macOS)
  ansible.builtin.command: date -u -v-{{ summary_retention_days }}d +"%Y-%m-%d %H:%M:%S"
  register: bsd_history_cutoff
  changed_when: false
  failed_when: false
  when:
    - summary_retention_days | int > 0
    - ansible_system != "Linux"

- name: Set cutoff date for retention
  ansible.builtin.set_fact:
    retention_cutoff_date: >-
      {% if ansible_system == "Linux" and linux_history_cutoff.rc is defined and linux_history_cutoff.rc == 0 %}
      {{ linux_history_cutoff.stdout }}
      {% elif ansible_system != "Linux" and bsd_history_cutoff.rc is defined and bsd_history_cutoff.rc == 0 %}
      {{ bsd_history_cutoff.stdout }}
      {% else %}
      null
      {% endif %}
  when: summary_retention_days | int > 0

- name: Apply retention policy to changes history for viewing
  ansible.builtin.set_fact:
    version_history: >-
      {{ version_history | combine({'changes': version_history.changes | default([]) |
         rejectattr('timestamp', 'lt', retention_cutoff_date) | list}) }}
  when:
    - retention_cutoff_date is defined
    - retention_cutoff_date != 'null'
    - version_history.changes is defined
    - version_history.changes | length > 0

- name: Apply retention policy to full history updates for viewing
  ansible.builtin.set_fact:
    version_history: >-
      {{ version_history | combine({'full_history': version_history.full_history | default({}) |
         combine({item.key: item.value | combine({'updates': item.value.updates | default([]) |
         rejectattr('timestamp', 'lt', retention_cutoff_date) | list})}, recursive=true)}) }}
  with_dict: "{{ version_history.full_history | default({}) }}"
  when:
    - retention_cutoff_date is defined
    - retention_cutoff_date != 'null'
    - version_history.full_history is defined
    - item.value.updates is defined
    - item.value.updates | length > 0

- name: Set view mode and service filter
  ansible.builtin.set_fact:
    view_mode: "{{ summary_view_mode }}"
    summary_service_filter: "{{ summary_service_filter }}"

# Display Changes History Table
- name: Display no changes message
  ansible.builtin.debug:
    msg:
      - "┌─────────────────────────────────────────────────────────────────────────────────┐"
      - "│ DOCKER SERVICE VERSION HISTORY - CHANGES                                       │"
      - "├─────────────────────────────────────────────────────────────────────────────────┤"
      - "│ No version changes have been recorded yet.                                      │"
      - "│ Run the playbook with container updates to generate history.                    │"
      - "└─────────────────────────────────────────────────────────────────────────────────┘"
  when:
    - view_mode == 'changes'
    - version_history.changes | default([]) | length == 0

- name: Prepare changes history table
  ansible.builtin.set_fact:
    history_changes_lines: "{{ lookup('template', 'history_changes_table.j2').split('\n') }}"
  when:
    - view_mode == 'changes'
    - version_history.changes | default([]) | length > 0

- name: Display changes history table
  ansible.builtin.debug:
    msg: "{{ history_changes_lines }}"
  when:
    - view_mode == 'changes'
    - version_history.changes | default([]) | length > 0

# Display Full History Table
- name: Display no history message
  ansible.builtin.debug:
    msg:
      - "┌─────────────────────────────────────────────────────────────────────────────────┐"
      - "│ MATRIX VERSION HISTORY - FULL SERVICE HISTORY                                   │"
      - "├─────────────────────────────────────────────────────────────────────────────────┤"
      - "│ No version history has been recorded yet.                                       │"
      - "│ Run the playbook with container updates to generate history.                    │"
      - "└─────────────────────────────────────────────────────────────────────────────────┘"
  when:
    - view_mode == 'full'
    - version_history.full_history | default({}) | length == 0

- name: Prepare full history table
  ansible.builtin.set_fact:
    history_full_lines: "{{ lookup('template', 'history_full_table.j2').split('\n') }}"
  when:
    - view_mode == 'full'
    - version_history.full_history | default({}) | length > 0

- name: Display full history table
  ansible.builtin.debug:
    msg: "{{ history_full_lines }}"
  when:
    - view_mode == 'full'
    - version_history.full_history | default({}) | length > 0
