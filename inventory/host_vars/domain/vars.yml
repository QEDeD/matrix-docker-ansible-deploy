# SPDX-FileCopyrightText: 2025 MDAD project contributors
# SPDX-License-Identifier: AGPL-3.0-or-later
---

########################################################################
#                                                                      #
# Matrix                                                               #
#                                                                      #
########################################################################

# The bare domain name which represents your Matrix identity.
# Matrix user ids for your server will be of the form (`@user:<matrix-domain>`).
#
# Note: this playbook does not touch the server referenced here.
# Installation happens on another server ("matrix.<matrix-domain>").
#
# If you've deployed using the wrong domain, you'll have to run the Uninstalling step,
# because you can't change the Domain after deployment.
#
# Example value: example.com
domain: "{{ vault_domain }}"
matrix_domain: "{{ domain }}"

# The Matrix homeserver software to install.
# See:
#  - `roles/custom/matrix-base/defaults/main.yml` for valid options
# - the `docs/configuring-playbook-IMPLEMENTATION_NAME.md` documentation page, if one is available for your implementation choice
matrix_homeserver_implementation: synapse

matrix_homeserver_generic_secret_key: "{{ vault_matrix_homeserver_generic_secret_key }}"

matrix_synapse_max_upload_size_mb: 150

# Enable generation of `/.well-known/matrix/support`.
matrix_static_files_file_matrix_support_enabled: true

# Homeserver admin contacts as per MSC 1929 https://github.com/matrix-org/matrix-spec-proposals/pull/1929
matrix_static_files_file_matrix_support_property_m_contacts:
  - matrix_id: "@qed:{{ matrix_domain }}"
    email_address: admin@{{ domain }}
    role: m.role.admin
#  - matrix_id: "@admin2:{{ matrix_domain }}"
#    email_address: admin2@example.com
#    role: m.role.admin
#  - email_address: security@example.com
#    role: m.role.security

# Your organization's support page on the base (or another) domain, if any
# matrix_static_files_file_matrix_support_property_m_support_page: "https://example.com/support"

matrix_matrixto_enabled: true

########################################################################
#                                                                      #
# /Matrix                                                              #
#                                                                      #
########################################################################

########################################################################
#                                                                      #
# Synapse & Element                                                    #
#                                                                      #
########################################################################

# Workers

matrix_synapse_workers_preset: one-of-each

# Element

# matrix_client_element_enabled: false

# Element location sharing (maps)
matrix_client_element_location_sharing_enabled: true
matrix_client_element_location_sharing_map_style_content_sources_localsource_tiles:
  - "https://tile.openstreetmap.org/{z}/{x}/{y}.png"
matrix_client_element_location_sharing_map_style_content_sources_localsource_attribution: "&copy; <a href=\"https://www.openstreetmap.org/copyright\" target=\"_blank\">OpenStreetMap</a> contributors"

# Compatibility for clients fetching map_style.json cross-origin
matrix_client_element_container_labels_traefik_additional_response_headers_custom:
  Access-Control-Allow-Origin: "*"

# Serve base domain

matrix_static_files_container_labels_base_domain_enabled: true

# Synapse Admin

matrix_synapse_admin_enabled: true

matrix_synapse_ext_password_provider_shared_secret_auth_enabled: true
matrix_synapse_ext_password_provider_shared_secret_auth_shared_secret: "{{ vault_matrix_synapse_ext_password_provider_shared_secret_auth_shared_secret }}"

# Synapse Stats
matrix_synapse_usage_exporter_enabled: true

# Enable MSC3030 (jump to date / timestamp_to_event).
matrix_synapse_configuration_extension_yaml: |
  experimental_features:
    msc3030_enabled: true

# (Optional) Expose endpoint if you want to collect statistics from outside (from other homeservers).
# If enabled, synapse-usage-exporter will be exposed publicly at `matrix.DOMAIN/report-usage-stats/push`.
# When collecting usage statistics for Synapse running on the same host, you don't need to enable this.
# You can adjust the hostname and path via `matrix_synapse_usage_exporter_hostname` and `matrix_synapse_usage_exporter_path_prefix`.
# matrix_synapse_usage_exporter_proxying_enabled: true

# Element Call
matrix_element_call_enabled: false
matrix_rtc_enabled: true

########################################################################
#                                                                      #
# /Synapse & Element                                                   #
#                                                                      #
########################################################################

########################################################################
#                                                                      #
# Coturn                                                               #
#                                                                      #
########################################################################

coturn_enabled: true

coturn_authentication_method: lt-cred-mech

coturn_container_network: "matrix-coturn"

# coturn_container_network: host

coturn_turn_external_ip_address: ""

coturn_allowed_peer_ips:
  - 10.0.0.0-10.255.255.255
  - 172.16.0.0-172.16.255.255
  - 192.168.2.0-192.168.127.255

coturn_denied_peer_ips:
  - 0.0.0.0-0.255.255.255
  - 10.0.0.0-10.255.255.255
  - 100.64.0.0-100.127.255.255
  - 127.0.0.0-127.255.255.255
  - 169.254.0.0-169.254.255.255
  - 172.16.0.0-172.31.255.255
  - 192.0.0.0-192.0.0.255
  - 192.0.2.0-192.0.2.255
  - 192.88.99.0-192.88.99.255
  - 192.168.0.0-192.168.255.255
  - 198.18.0.0-198.19.255.255
  - 198.51.100.0-198.51.100.255
  - 203.0.113.0-203.0.113.255
  - 224.0.0.0-239.255.255.255
  - 240.0.0.0-255.255.255.255
  - ::1
  - 64:ff9b::-64:ff9b::ffff:ffff
  - ::ffff:0.0.0.0-::ffff:255.255.255.255
  - 100::-100::ffff:ffff:ffff:ffff
  - 2001::-2001:1ff:ffff:ffff:ffff:ffff:ffff:ffff
  - 2002::-2002:ffff:ffff:ffff:ffff:ffff:ffff:ffff
  - fc00::-fdff:ffff:ffff:ffff:ffff:ffff:ffff:ffff
  - fe80::-febf:ffff:ffff:ffff:ffff:ffff:ffff:ffff
  - ff00::-ffff:ffff:ffff:ffff:ffff:ffff:ffff:ffff

########################################################################
#                                                                      #
# /Coturn                                                              #
#                                                                      #
########################################################################

########################################################################
#                                                                      #
# Bridges                                                              #
#                                                                      #
########################################################################

matrix_bridges_encryption_enabled: true
matrix_bridges_encryption_default: true
matrix_appservice_double_puppet_enabled: true

# Signal bridge
matrix_mautrix_signal_enabled: true

# WhatsApp bridge
matrix_mautrix_whatsapp_enabled: true

# Meta Messenger bridge
matrix_mautrix_meta_messenger_enabled: false

########################################################################
#                                                                      #
# /Bridges                                                             #
#                                                                      #
########################################################################

########################################################################
#                                                                      #
# Docker Ansible Summary                                               #
#                                                                      #
########################################################################

docker_ansible_summary_enabled: true
docker_ansible_summary_scope:
  - "matrix-*"
  - "mash-*"
# docker_ansible_summary_history_max_entries: 100
# docker_ansible_summary_retention_days: 365
# docker_ansible_summary_table_style_unicode: false

########################################################################
#                                                                      #
# /Docker Ansible Summary                                              #
#                                                                      #
########################################################################

########################################################################
#                                                                      #
# Traefik                                                              #
#                                                                      #
########################################################################

# This is something which is provided to Let's Encrypt when retrieving SSL certificates for domains.
#
# In case SSL renewal fails at some point, you'll also get an email notification there.
#
# If you decide to use another method for managing SSL certificates (different than the default Let's Encrypt),
# you won't be required to define this variable (see `docs/configuring-playbook-ssl-certificates.md`).
#
# Example value: someone@example.com

traefik_config_certificatesResolvers_acme_email: "{{ admin_user_email }}"  # noqa var-naming

traefik_dashboard_enabled: true
traefik_dashboard_hostname: "{{ matrix_server_fqn_matrix }}"
traefik_dashboard_basicauth_enabled: true
traefik_dashboard_basicauth_user: "{{ vault_traefik_dashboard_basicauth_user }}"
traefik_dashboard_basicauth_password: "{{ vault_traefik_dashboard_basicauth_password }}"

# By default, the playbook manages its own Traefik (https://doc.traefik.io/traefik/) reverse-proxy server.
# It will retrieve SSL certificates for you on-demand and forward requests to all other components.
# For alternatives, see `docs/configuring-playbook-own-webserver.md`.
matrix_playbook_reverse_proxy_type: playbook-managed-traefik

# Additional domains for individual certificates (for your working HA setup)
# traefik_additional_domains_to_obtain_certificates_for: ["ha.{{ domain }}"]

traefik_configuration_extension_yaml: |
  providers:
    file:
      directory: /config/
      watch: true
      filename: ""

traefik_config_http_middlewares_custom:
  authentik-forwardauth:
    forwardAuth:
      address: "http://mash-authentik-server:9000/outpost.goauthentik.io/auth/traefik"
      trustForwardHeader: true
      authResponseHeaders:
        - X-authentik-username
        - X-authentik-groups
        - X-authentik-email
        - X-authentik-name
        - X-authentik-uid
        - X-authentik-jwt

aux_file_definitions:
  # This file triggers wildcard certificate acquisition for *.{{ domain }}
  - dest: "{{ traefik_config_dir_path }}/provider_wildcard.yml"
    content: |
      http:
        routers:
          wildcard-cert-trigger:
            rule: "Host(`wildcard-trigger.{{ domain }}`)"
            service: "noop@internal"
            tls:
              certResolver: default
              domains:
                - main: "{{ domain }}"
                  sans:
                    - "*.{{ domain }}"
            priority: -1
  # This file is for the Home Assistant reverse proxy
  - dest: "{{ traefik_config_dir_path }}/provider_ha_homeassistant.yml"
    content: |
      http:
        routers:
          ha_homeassistant_router:
            rule: "Host(`ha.{{ domain }}`)"
            service: ha_homeassistant_service
            tls:
              certResolver: default
        services:
          ha_homeassistant_service:
            loadBalancer:
              servers:
                - url: "http://10.1.154.4:8123"
  - dest: "{{ traefik_config_dir_path }}/provider_authentik_outpost.yml"
    content: |
      http:
        routers:
          authentik-outpost:
            rule: "HostRegexp(`{subdomain:[a-z0-9-]+}.{{ domain }}`) && PathPrefix(`/outpost.goauthentik.io/`)"
            entryPoints: ["web-secure"]
            priority: 10000
            service: authentik-embedded
            tls:
              certResolver: "{{ traefik_certResolver_primary }}"
        services:
          authentik-embedded:
            loadBalancer:
              servers:
                - url: "http://mash-authentik-server:9000"

# ──────────────────────────────────────────────────────────────
# TRAEFIK ACME / DNS‑01 SETTINGS
# ──────────────────────────────────────────────────────────────

# Enable the DNS‑01 challenge via Cloudflare
traefik_config_certificatesResolvers_acme_dnsChallenge_enabled: true  # noqa var-naming
traefik_config_certificatesResolvers_acme_dnsChallenge_provider: "cloudflare"  # noqa var-naming
traefik_config_certificatesResolvers_acme_dnsChallenge_delayBeforeCheck: 60  # noqa var-naming
traefik_config_certificatesResolvers_acme_dnsChallenge_resolvers:  # noqa var-naming
  - "1.1.1.1:53"

# Cloudflare API credentials (pulled from your Ansible Vault)
# Note: No quotes around Ansible variables to prevent double-quoting in final environment
traefik_environment_variables: |
  CLOUDFLARE_API_EMAIL={{ vault_cloudflare_api_email }}
  CLOUDFLARE_DNS_API_TOKEN={{ vault_cloudflare_dns_edit_token }}
  CLOUDFLARE_ZONE_API_TOKEN={{ vault_cloudflare_zone_read_token }}
  LEGO_DISABLE_CNAME_SUPPORT=true
# ──────────────────────────────────────────────────────────────

########################################################################
#                                                                      #
# /Traefik                                                             #
#                                                                      #
########################################################################

########################################################################
#                                                                      #
# ddclient                                                             #
#                                                                      #
########################################################################

ddclient_enabled: true

ddclient_domain_configurations:
  - protocol: cloudflare
    zone: "{{ domain }}"
    ttl: 1
    username: "token"
    password: "{{ vault_matrix_dynamic_dns_cloudflare_api_token }}"
    domain: "{{ domain }}"

########################################################################
#                                                                      #
# /ddclient                                                            #
#                                                                      #
########################################################################

# A secret used to protect access keys issued by the server.
# You can put any string here, but generating a strong one is preferred (e.g. `pwgen -s 64 1`).
matrix_synapse_macaroon_secret_key: "{{ vault_matrix_synapse_macaroon_secret_key }}"

# A Postgres password to use for the superuser Postgres user (called `matrix` by default).
#
# The playbook creates additional Postgres users and databases (one for each enabled service)
# using this superuser account.
postgres_connection_password: "{{ vault_postgres_connection_password }}"

########################################################################
#                                                                      #
# Prometheus & Grafana                                                 #
#                                                                      #
########################################################################

prometheus_enabled: true

prometheus_node_exporter_enabled: true

grafana_enabled: true

grafana_anonymous_access: false

# This has no relation to your Matrix user id. It can be any username you'd like.
# Changing the username subsequently won't work.
grafana_default_admin_user: "{{ admin_user_email }}"

# Changing the password subsequently won't work.
grafana_default_admin_password: "{{ vault_grafana_default_admin_password }}"

########################################################################
#                                                                      #
# /Prometheus & Grafana                                                #
#                                                                      #
########################################################################

########################################################################
#                                                                      #
# Docker                                                               #
#                                                                      #
########################################################################

matrix_playbook_docker_installation_enabled: false

########################################################################
#                                                                      #
# /Docker                                                              #
#                                                                      #
########################################################################

########################################################################
#                                                                      #
# exim                                                                 #
#                                                                      #
########################################################################

exim_relay_relay_use: true
exim_relay_sender_address: "{{ vault_exim_relay_sender_address }}"
exim_relay_relay_host_name: "{{ vault_exim_relay_relay_host_name }}"
exim_relay_relay_host_port: "{{ vault_exim_relay_relay_host_port | int }}"
exim_relay_relay_auth: true
exim_relay_relay_auth_username: "{{ vault_exim_relay_relay_auth_username }}"
exim_relay_relay_auth_password: "{{ vault_exim_relay_relay_auth_password }}"

########################################################################
#                                                                      #
# /exim                                                                #
#                                                                      #
########################################################################
